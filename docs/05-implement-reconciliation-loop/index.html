<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>5. Implement reconciliation - Sample Controller</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://www.nakamasato.com/sample-controller/favicon.png><link rel=stylesheet href=/sample-controller/css/style.min.6719d72e323121369d5caeb4264b95d8a63cf1deaab029da67602fe5a046e0a4.css></head><body class='page page-default-single'><div id=main-menu-mobile class=main-menu-mobile><ul><li class=menu-item-home><a href=/sample-controller/><span>Home</span></a></li><li class=menu-item-docs><a href=/sample-controller/docs/><span>Docs</span></a></li></ul></div><div class=wrapper><div class=header><div class=container><div class=logo><a href=https://www.nakamasato.com/sample-controller><img alt=Logo src=/sample-controller/images/logo.svg></a></div><div class=logo-mobile><a href=https://www.nakamasato.com/sample-controller><img alt=Logo src=/sample-controller/images/logo-mobile.svg></a></div><div id=main-menu class=main-menu><ul><li class=menu-item-home><a href=/sample-controller/><span>Home</span></a></li><li class=menu-item-docs><a href=/sample-controller/docs/><span>Docs</span></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pt-2 pt-md-6 pb-3 pb-md-6"><div class=row><div class="col-12 col-md-3 mb-3"><div class=sidebar><div class=docs-menu><h4>Docs</h4><ul><li><a href=https://www.nakamasato.com/sample-controller/docs/00-init-module/>0. Initialize Go module</a></li><li><a href=https://www.nakamasato.com/sample-controller/docs/01-define-go-types-for-crd/>1. Define Go types for CRD</a></li><li><a href=https://www.nakamasato.com/sample-controller/docs/02-generate-code/>2. Generate codes</a></li><li><a href=https://www.nakamasato.com/sample-controller/docs/03-create-crd-yaml/>3. Create CRD yaml file</a></li><li><a href=https://www.nakamasato.com/sample-controller/docs/04-check-points-check-custom-resource-and-codes/>4. Checkpoint</a></li><li class=active><a href=https://www.nakamasato.com/sample-controller/docs/05-implement-reconciliation-loop/>5. Implement reconciliation</a></li></ul></div></div></div><div class="col-12 col-md-9"><h1 class=title>5. Implement reconciliation</h1><div class=content><h2 id=create-controller><a href=https://github.com/nakamasato/sample-controller/commit/6b9827020cc9de23883e30bd338b600c62aeff28>5.1. Create Controller</a></h2><h3 id=511-overview>5.1.1. Overview</h3><p><img src=overview-1.drawio.svg alt></p><h3 id=511-implement>5.1.1. Implement</h3><ol><li>Define <code>Controller</code> struct with <code>sampleclientset</code> and <code>foosSynced</code>.<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Controller</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sampleclientset</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>    <span class=nx>fooSynced</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>InformerSynced</span> <span class=c1>// a function that can be used to determine if an informer has synced
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div></li><li>Define <code>NewController</code> function<ol><li>Create <code>Controller</code> with the arguments <code>sampleclientset</code> and <code>fooInformer</code>, which will be passed in <code>main.go</code>.</li><li>Add event handlers for <code>AddFunc</code> and <code>DeleteFunc</code> to the informer.</li><li>Return the controller.</li></ol></li><li>Define <code>Run</code>, which will be called in <code>main.go</code>.<ol><li>Wait until the cache is synced.</li><li>Run <code>c.runWorker</code> repeatedly every second until the stop channel is closed.</li></ol></li><li>Define <code>runWorker</code>: do nothing</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>clientset</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/clientset/versioned&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>informers</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/informers/externalversions/example.com/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>listers</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/listers/example.com/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/util/wait&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/util/workqueue&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/klog/v2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Controller</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// sampleclientset is a clientset for our own API group
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sampleclientset</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>foosSynced</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>InformerSynced</span> <span class=c1>// cache is synced for foo
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewController</span><span class=p>(</span><span class=nx>sampleclientset</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>fooInformer</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>FooInformer</span><span class=p>)</span> <span class=o>*</span><span class=nx>Controller</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>controller</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Controller</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>sampleclientset</span><span class=p>:</span> <span class=nx>sampleclientset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>foosSynced</span><span class=p>:</span>      <span class=nx>fooInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nx>HasSynced</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fooInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>controller</span><span class=p>.</span><span class=nx>handleAdd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>handleDelete</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error occurred when adding event handler %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>FlushAndExit</span><span class=p>(</span><span class=nx>klog</span><span class=p>.</span><span class=nx>ExitFlushTimeout</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>controller</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>foosSynced</span><span class=p>);</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to wait for caches to sync&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>runWorker</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>stopCh</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>runWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;runWorker is called&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>handleAdd</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;handleAdd is called&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>handleDelete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;handleDelete is called&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>main.go:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl> import (
</span></span><span class=line><span class=cl><span class=gd>-       &#34;context&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span>        &#34;flag&#34;
</span></span><span class=line><span class=cl>        &#34;path/filepath&#34;
</span></span><span class=line><span class=cl><span class=gi>+       &#34;time&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>        &#34;k8s.io/client-go/tools/clientcmd&#34;
</span></span><span class=line><span class=cl>        &#34;k8s.io/client-go/util/homedir&#34;
</span></span><span class=line><span class=cl>        &#34;k8s.io/klog/v2&#34;
</span></span><span class=line><span class=cl><span class=gd>-       metav1 &#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span>
</span></span><span class=line><span class=cl>        clientset &#34;github.com/nakamasato/sample-controller/pkg/generated/clientset/versioned&#34;
</span></span><span class=line><span class=cl><span class=gi>+       informers &#34;github.com/nakamasato/sample-controller/pkg/generated/informers/externalversions&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> )
</span></span><span class=line><span class=cl> func main() {
</span></span><span class=line><span class=cl><span class=gu>@@ -34,9 +34,11 @@ func main() {
</span></span></span><span class=line><span class=cl><span class=gu></span>                klog.Fatalf(&#34;Error building example clientset: %s&#34;, err.Error())
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gd>-       foos, err := exampleClient.ExampleV1alpha1().Foos(&#34;&#34;).List(context
</span></span></span><span class=line><span class=cl><span class=gd></span>.Background(), metav1.ListOptions{})
</span></span><span class=line><span class=cl><span class=gd>-       if err != nil {
</span></span></span><span class=line><span class=cl><span class=gd>-               klog.Fatalf(&#34;listing foos %s&#34;, err.Error())
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+       exampleInformerFactory := informers.NewSharedInformerFactory(examp
</span></span></span><span class=line><span class=cl><span class=gi></span>leClient, time.Second*30)
</span></span><span class=line><span class=cl><span class=gi>+       stopCh := make(chan struct{})
</span></span></span><span class=line><span class=cl><span class=gi>+       controller := NewController(exampleClient, exampleInformerFactory.
</span></span></span><span class=line><span class=cl><span class=gi></span>Example().V1alpha1().Foos())
</span></span><span class=line><span class=cl><span class=gi>+       exampleInformerFactory.Start(stopCh)
</span></span></span><span class=line><span class=cl><span class=gi>+       if err = controller.Run(stopCh); err != nil {
</span></span></span><span class=line><span class=cl><span class=gi>+               klog.Fatalf(&#34;error occurred when running controller %s&#34;,
</span></span></span><span class=line><span class=cl><span class=gi></span> err.Error())
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl><span class=gd>-       klog.Infof(&#34;length of foos is %d&#34;, len(foos.Items))
</span></span></span><span class=line><span class=cl><span class=gd></span> }
</span></span></code></pre></div><p>At the line of <code>exampleInformerFactory := informers.NewSharedInformerFactory(exampleClient, time.Second*30)</code>, the second argument specifies <em><strong>ResyncPeriod</strong></em>, which defines the interval of <em><strong>resync</strong></em> (<em>The resync operation consists of delivering to the handler an update notification for every object in the informer&rsquo;s local cache</em>). For more detail, please read <a href=https://pkg.go.dev/k8s.io/client-go@v0.23.1/tools/cache#NewSharedIndexInformer>NewSharedIndexInformer</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;path/filepath&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/klog/v2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>clientset</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/clientset/versioned&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>informers</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/informers/externalversions&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>InitFlags</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>kubeconfig</span> <span class=o>*</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>home</span> <span class=o>:=</span> <span class=nx>homedir</span><span class=p>.</span><span class=nf>HomeDir</span><span class=p>();</span> <span class=nx>home</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>home</span><span class=p>,</span> <span class=s>&#34;.kube&#34;</span><span class=p>,</span> <span class=s>&#34;config&#34;</span><span class=p>),</span> <span class=s>&#34;(optional)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;absolute path to kubeconfig file&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nf>BuildConfigFromFlags</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>kubeconfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building kubeconfig: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>exampleClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientset</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building example clientset: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>exampleInformerFactory</span> <span class=o>:=</span> <span class=nx>informers</span><span class=p>.</span><span class=nf>NewSharedInformerFactory</span><span class=p>(</span><span class=nx>exampleClient</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=o>*</span><span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>controller</span> <span class=o>:=</span> <span class=nf>NewController</span><span class=p>(</span><span class=nx>exampleClient</span><span class=p>,</span> <span class=nx>exampleInformerFactory</span><span class=p>.</span><span class=nf>Example</span><span class=p>().</span><span class=nf>V1alpha1</span><span class=p>().</span><span class=nf>Foos</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>exampleInformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>controller</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error occurred when running controller %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=513-run-and-check>5.1.3 Run and check</h3><ol><li><p>Run the controller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li><p>Create and delete CR.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span></code></pre></div></li><li><p>Check the controller logs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2022/07/18 06:36:35 handleAdd is called
</span></span><span class=line><span class=cl>2022/07/18 06:36:40 handleDelete is called
</span></span></code></pre></div></li></ol><h2 id=fetch-foo-object><a href=https://github.com/nakamasato/sample-controller/commit/2ae0825e2a49b6e6670d06846e132b0657edc654>5.2. Fetch Foo object</a></h2><h3 id=521-overview>5.2.1. Overview</h3><p><img src=overview-2.drawio.svg alt></p><p>Implement the following logic:</p><ol><li>Add <code>workqueue</code> and <code>listers</code> to <code>Controller</code> struct.</li><li>Add the key for the triggerred object to <code>workqueue</code> in <code>handleAdd</code> and <code>handleUpdate</code>. (e.g. <code>Foo</code> -> <code>&lt;namespace>/&lt;name></code>)</li><li>Get a <code>workqueue</code> item (<code>&lt;namespace>/&lt;name></code>).</li><li>Get the <code>Foo</code> resource with namespace and name from the <code>lister</code>.</li><li>Forget the item from <code>workqueue</code>.</li></ol><h3 id=522-implement>5.2.2. Implement</h3><ol><li><p>Add <code>workqueue</code> and <code>listers</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;k8s.io/client-go/util/workqueue&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>listers</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/listers/example.com/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl> type Controller struct {
</span></span><span class=line><span class=cl>     sampleclientset clientset.Interface
</span></span><span class=line><span class=cl>     fooSynced       cache.InformerSynced
</span></span><span class=line><span class=cl><span class=gi>+    foosLister      listers.FooLister
</span></span></span><span class=line><span class=cl><span class=gi>+    workqueue       workqueue.RateLimitingInterface
</span></span></span><span class=line><span class=cl><span class=gi></span> }
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl> controller := &amp;Controller{
</span></span><span class=line><span class=cl>     sampleclientset: sampleclientset,
</span></span><span class=line><span class=cl>     fooSynced:       fooInformer.Informer().HasSynced,
</span></span><span class=line><span class=cl><span class=gi>+    foosLister:      fooInformer.Lister(),
</span></span></span><span class=line><span class=cl><span class=gi>+    workqueue:       workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), &#34;foo&#34;),
</span></span></span><span class=line><span class=cl><span class=gi></span> }
</span></span></code></pre></div></li><li><p>Define <code>enqueueFoo</code> to convert Foo resource into namespace/name string before putting into the workqueue.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>handleAdd</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;handleAdd is called&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>enqueueFoo</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>handleDelete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;handleDelete is called&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>enqueueFoo</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// enqueueFoo takes a Foo resource and converts it into a namespace/name
</span></span></span><span class=line><span class=cl><span class=c1>// string which is then put onto the work queue. This method should *not* be
</span></span></span><span class=line><span class=cl><span class=c1>// passed resources of any type other than Foo.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>enqueueFoo</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>key</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>MetaNamespaceKeyFunc</span><span class=p>(</span><span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get key from the cache %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>Create <code>processNextWorkItem</code> function that processes a queue item from workqueue.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>processNextWorkItem</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>obj</span><span class=p>,</span> <span class=nx>shutdown</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>shutdown</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// wrap this block in a func to use defer c.workqueue.Done
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// call Done to tell workqueue that the item was finished processing
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>defer</span> <span class=nx>c</span><span class=p>.</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>key</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>ok</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>obj</span><span class=p>.(</span><span class=kt>string</span><span class=p>);</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// As the item in the workqueue is actually invalid, we call
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// Forget here else we&#39;d go into a loop of attempting to
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// process a work item that is invalid.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>c</span><span class=p>.</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>Forget</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;expected string in workqueue but got %#v&#34;</span><span class=p>,</span> <span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>ns</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>SplitMetaNamespaceKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to split key into namespace and name %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// temporary main logic
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>foo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>foosLister</span><span class=p>.</span><span class=nf>Foos</span><span class=p>(</span><span class=nx>ns</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get foo resource from lister %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Got foo %+v&#34;</span><span class=p>,</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>Spec</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Forget the queue item as it&#39;s successfully processed and
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// the item will not be requeued.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>c</span><span class=p>.</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>Forget</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Successfully synced &#39;%s&#39;&#34;</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>Call <code>processNextWorkItem</code> in <code>runWork</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>runWorker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>c</span><span class=p>.</span><span class=nf>processNextWorkItem</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li></ol><h3 id=523-run-and-check>5.2.3. Run and check</h3><ol><li><p>Run the controller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li><p>Create and delete CR.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span></code></pre></div></li><li><p>Check the controller logs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2022/07/18 07:46:42 handleAdd is called
</span></span><span class=line><span class=cl>2022/07/18 07:46:42 Got foo {DeploymentName:foo-sample Replicas:0x1400030194c}
</span></span><span class=line><span class=cl>2022/07/18 07:46:42 Successfully synced &#39;default/foo-sample&#39;
</span></span><span class=line><span class=cl>2022/07/18 07:46:49 handleDelete is called
</span></span><span class=line><span class=cl>2022/07/18 07:46:49 failed to get foo resource from lister foo.example.com &#34;foo-sample&#34; not found
</span></span></code></pre></div></li></ol><h2 id=create-delete-deployment-for-foo-resource><a href=https://github.com/nakamasato/sample-controller/commit/42782d08db8d395bafb6db687516b65f3978c07d>5.3. Create/Delete Deployment for Foo resource</a></h2><h3 id=531-overview>5.3.1. Overview</h3><p><img src=overview-3.drawio.svg alt></p><p>In this section, we&rsquo;ll add a logic to create a <code>Deployment</code> for <code>Foo</code> resource.</p><p>The logic to implement is:</p><ol><li>Add <code>clientset</code>, <code>informer</code> and <code>lister</code> for <code>Deployment</code> to <code>Controller</code>.</li><li>Initialize <code>clientset</code> and <code>informer</code> in <code>main.go</code> and pass them to a Controller when initializing it.</li><li>In <code>syncHandler</code> func, add a logic to create a Deployment if there doesn&rsquo;t exist a Deployment with name <code>foo.spec.deploymentName</code> in the same namespace as Foo object.</li><li>Set <code>OwnerReferences</code> for a new Deployment in <code>newDeployment</code> so that the Deployment will be cleaned up when the owner, <code>Foo</code> object, is deleted.</li></ol><h3 id=532-implement>5.3.2. Implement</h3><ol><li><p>Import the necessary packages.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>appsinformers</span> <span class=s>&#34;k8s.io/client-go/informers/apps/v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>appslisters</span> <span class=s>&#34;k8s.io/client-go/listers/apps/v1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div></li><li><p>Add fields (<code>kubeclientset</code>, <code>deploymentsLister</code>, and <code>deploymentsSynced</code>) to <code>Controller</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl> type Controller struct {
</span></span><span class=line><span class=cl><span class=gi>+       // kubeclientset is a standard kubernetes clientset
</span></span></span><span class=line><span class=cl><span class=gi>+       kubeclientset kubernetes.Interface
</span></span></span><span class=line><span class=cl><span class=gi></span>        // sampleclientset is a clientset for our own API group
</span></span><span class=line><span class=cl>        sampleclientset clientset.Interface
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+       deploymentsLister appslisters.DeploymentLister
</span></span></span><span class=line><span class=cl><span class=gi>+       deploymentsSynced cache.InformerSynced
</span></span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi></span>        foosLister listers.FooLister
</span></span><span class=line><span class=cl>        foosSynced cache.InformerSynced // cache is synced for foo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gu>@@ -24,12 +39,19 @@ type Controller struct {
</span></span></span><span class=line><span class=cl><span class=gu></span>        workqueue workqueue.RateLimitingInterface
</span></span><span class=line><span class=cl> }
</span></span></code></pre></div></li><li><p>Update <code>NewController</code> as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>-func NewController(sampleclientset clientset.Interface, fooInformer informers.FooInformer) *Controller {
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+func NewController(
</span></span></span><span class=line><span class=cl><span class=gi>+       kubeclientset kubernetes.Interface,
</span></span></span><span class=line><span class=cl><span class=gi>+       sampleclientset clientset.Interface,
</span></span></span><span class=line><span class=cl><span class=gi>+       deploymentInformer appsinformers.DeploymentInformer,
</span></span></span><span class=line><span class=cl><span class=gi>+       fooInformer informers.FooInformer) *Controller {
</span></span></span><span class=line><span class=cl><span class=gi></span>        controller := &amp;Controller{
</span></span><span class=line><span class=cl><span class=gd>-               sampleclientset: sampleclientset,
</span></span></span><span class=line><span class=cl><span class=gd>-               foosSynced:      fooInformer.Informer().HasSynced,
</span></span></span><span class=line><span class=cl><span class=gd>-               foosLister:      fooInformer.Lister(),
</span></span></span><span class=line><span class=cl><span class=gd>-               workqueue:       workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), &#34;foo&#34;),
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+               kubeclientset:     kubeclientset,
</span></span></span><span class=line><span class=cl><span class=gi>+               sampleclientset:   sampleclientset,
</span></span></span><span class=line><span class=cl><span class=gi>+               deploymentsLister: deploymentInformer.Lister(),
</span></span></span><span class=line><span class=cl><span class=gi>+               deploymentsSynced: deploymentInformer.Informer().HasSynced,
</span></span></span><span class=line><span class=cl><span class=gi>+               foosLister:        fooInformer.Lister(),
</span></span></span><span class=line><span class=cl><span class=gi>+               foosSynced:        fooInformer.Informer().HasSynced,
</span></span></span><span class=line><span class=cl><span class=gi>+               workqueue:         workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), &#34;foo&#34;),
</span></span></span><span class=line><span class=cl><span class=gi></span>        }
</span></span></code></pre></div></li><li><p>Update <code>main.go</code> to pass the added arguments to <code>NewController</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>import (
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=gi>+       kubeinformers &#34;k8s.io/client-go/informers&#34;
</span></span></span><span class=line><span class=cl><span class=gi>+       &#34;k8s.io/client-go/kubernetes&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>...
</span></span><span class=line><span class=cl>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>func main() {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=gi>+       kubeClient, err := kubernetes.NewForConfig(config)
</span></span></span><span class=line><span class=cl><span class=gi>+       if err != nil {
</span></span></span><span class=line><span class=cl><span class=gi>+               klog.Errorf(&#34;getting kubernetes client set %s&#34;, err.Error())
</span></span></span><span class=line><span class=cl><span class=gi>+       }
</span></span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi></span>        exampleClient, err := clientset.NewForConfig(config)
</span></span><span class=line><span class=cl>        if err != nil {
</span></span><span class=line><span class=cl>                klog.Errorf(&#34;getting client set %s&#34;, err.Error())
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+       kubeInformerFactory := kubeinformers.NewSharedInformerFactory(kubeClient, time.Second*30)
</span></span></span><span class=line><span class=cl><span class=gi></span>        exampleInformerFactory := informers.NewSharedInformerFactory(exampleClient, time.Second*30)
</span></span><span class=line><span class=cl>        stopCh := make(chan struct{})
</span></span><span class=line><span class=cl><span class=gd>-       controller := NewController(exampleClient, exampleInformerFactory.Example().V1alpha1().Foos())
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+       controller := NewController(
</span></span></span><span class=line><span class=cl><span class=gi>+               kubeClient,
</span></span></span><span class=line><span class=cl><span class=gi>+               exampleClient,
</span></span></span><span class=line><span class=cl><span class=gi>+               kubeInformerFactory.Apps().V1().Deployments(),
</span></span></span><span class=line><span class=cl><span class=gi>+               exampleInformerFactory.Example().V1alpha1().Foos(),
</span></span></span><span class=line><span class=cl><span class=gi>+       )
</span></span></span><span class=line><span class=cl><span class=gi>+       kubeInformerFactory.Start(stopCh)
</span></span></span><span class=line><span class=cl><span class=gi></span>    ...
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div></li><li><p>Create <code>syncHandler</code> and <code>newDeployment</code> in <code>controller.go</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>syncHandler</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ns</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>SplitMetaNamespaceKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to split key into namespace and name %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>foo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>foosLister</span><span class=p>.</span><span class=nf>Foos</span><span class=p>(</span><span class=nx>ns</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get foo resource from lister %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>deploymentName</span> <span class=o>:=</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DeploymentName</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>deploymentName</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;deploymentName must be specified %s&#34;</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>deployment</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>deploymentsLister</span><span class=p>.</span><span class=nf>Deployments</span><span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>deploymentName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>deployment</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>kubeclientset</span><span class=p>.</span><span class=nf>AppsV1</span><span class=p>().</span><span class=nf>Deployments</span><span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Create</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nf>newDeployment</span><span class=p>(</span><span class=nx>foo</span><span class=p>),</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>CreateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;deployment %s is valid&#34;</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newDeployment</span><span class=p>(</span><span class=nx>foo</span> <span class=o>*</span><span class=nx>samplev1alpha1</span><span class=p>.</span><span class=nx>Foo</span><span class=p>)</span> <span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>labels</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;app&#34;</span><span class=p>:</span>        <span class=s>&#34;nginx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;controller&#34;</span><span class=p>:</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>Name</span><span class=p>:</span>            <span class=nx>foo</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>DeploymentName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>Namespace</span><span class=p>:</span>       <span class=nx>foo</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>OwnerReferences</span><span class=p>:</span> <span class=p>[]</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>OwnerReference</span><span class=p>{</span><span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nf>NewControllerRef</span><span class=p>(</span><span class=nx>foo</span><span class=p>,</span> <span class=nx>samplev1alpha1</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithKind</span><span class=p>(</span><span class=s>&#34;Foo&#34;</span><span class=p>))},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>Spec</span><span class=p>:</span> <span class=nx>appsv1</span><span class=p>.</span><span class=nx>DeploymentSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>Replicas</span><span class=p>:</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>Selector</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>MatchLabels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>Template</span><span class=p>:</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>PodTemplateSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=nx>Spec</span><span class=p>:</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>PodSpec</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>Containers</span><span class=p>:</span> <span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Container</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>Name</span><span class=p>:</span>  <span class=s>&#34;nginx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=nx>Image</span><span class=p>:</span> <span class=s>&#34;nginx:latest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Add necessary imports</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>appsv1</span> <span class=s>&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>corev1</span> <span class=s>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>samplev1alpha1</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/apis/example.com/v1alpha1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div></li><li><p>Update <code>processNextWorkItem</code> to call <code>syncHandler</code> for main logic.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -77,20 +99,12 @@ func (c *Controller) processNextWorkItem() bool {
</span></span></span><span class=line><span class=cl><span class=gu></span>                        return nil
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gd>-               ns, name, err := cache.SplitMetaNamespaceKey(key)
</span></span></span><span class=line><span class=cl><span class=gd>-               if err != nil {
</span></span></span><span class=line><span class=cl><span class=gd>-                       klog.Errorf(&#34;failed to split key into namespace and name %s&#34;, err.Error())
</span></span></span><span class=line><span class=cl><span class=gd>-                       return err
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+               if err := c.syncHandler(key); err != nil {
</span></span></span><span class=line><span class=cl><span class=gi>+                       // Put the item back on the workqueue to handle any transient errors.
</span></span></span><span class=line><span class=cl><span class=gi>+                       c.workqueue.AddRateLimited(key)
</span></span></span><span class=line><span class=cl><span class=gi>+                       return fmt.Errorf(&#34;error syncing &#39;%s&#39;: %s, requeuing&#34;, key, err.Error())
</span></span></span><span class=line><span class=cl><span class=gi></span>                }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gd>-               // temporary main logic
</span></span></span><span class=line><span class=cl><span class=gd>-               foo, err := c.foosLister.Foos(ns).Get(name)
</span></span></span><span class=line><span class=cl><span class=gd>-               if err != nil {
</span></span></span><span class=line><span class=cl><span class=gd>-                       klog.Errorf(&#34;failed to get foo resource from lister %s&#34;, err.Error())
</span></span></span><span class=line><span class=cl><span class=gd>-                       return err
</span></span></span><span class=line><span class=cl><span class=gd>-               }
</span></span></span><span class=line><span class=cl><span class=gd>-               klog.Infof(&#34;Got foo %+v&#34;, foo.Spec)
</span></span></span><span class=line><span class=cl><span class=gd>-
</span></span></span><span class=line><span class=cl><span class=gd></span>                // Forget the queue item as it&#39;s successfully processed and
</span></span><span class=line><span class=cl>                // the item will not be requeued.
</span></span><span class=line><span class=cl>                c.workqueue.Forget(obj)
</span></span></code></pre></div></li><li><p>Delete <code>handleDelete</code> function as it&rsquo;s covered by <code>ownerReferences</code> (details mentioned in the next step) for delete action.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>        fooInformer.Informer().AddEventHandler(
</span></span><span class=line><span class=cl>                cache.ResourceEventHandlerFuncs{
</span></span><span class=line><span class=cl>                        AddFunc:    controller.handleAdd,
</span></span><span class=line><span class=cl><span class=gd>-                       DeleteFunc: controller.handleDelete,
</span></span></span><span class=line><span class=cl><span class=gd></span>                },
</span></span><span class=line><span class=cl>        )
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>-func (c *Controller) handleDelete(obj interface{}) {
</span></span></span><span class=line><span class=cl><span class=gd>-       klog.Info(&#34;handleDelete is called&#34;)
</span></span></span><span class=line><span class=cl><span class=gd>-       c.enqueueFoo(obj)
</span></span></span><span class=line><span class=cl><span class=gd>-}
</span></span></span></code></pre></div></li></ol><h3 id=533-run-and-check>5.3.3. Run and check</h3><ol><li><p>Run the controller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li><p>Create <code>Foo</code> resource.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div><p>Check <code>Deployment</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get deploy
</span></span><span class=line><span class=cl>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>foo-sample   0/1     1            0           3s
</span></span></code></pre></div><p>Check <code>sample-controller</code>&rsquo;s logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2022/07/18 09:33:31 handleAdd is called
</span></span><span class=line><span class=cl>2022/07/18 09:33:31 deployment foo-sample is valid
</span></span><span class=line><span class=cl>2022/07/18 09:33:31 Successfully synced &#39;default/foo-sample&#39;
</span></span></code></pre></div></li><li><p>Delete <code>Foo</code> resource.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span></code></pre></div><p>Check <code>Deployment</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get deploy
</span></span><span class=line><span class=cl>No resources found in default namespace.
</span></span></code></pre></div><p><code>Deployment</code> is deleted when the corresponding <code>Foo</code> is deleted thanks to <code>OwnerReference</code>&rsquo;s <a href=https://kubernetes.io/docs/concepts/architecture/garbage-collection/#cascading-deletion>cascading deletion</a> feature:</p><blockquote><p>Kubernetes checks for and deletes objects that no longer have owner references, like the pods left behind when you delete a ReplicaSet. When you delete an object, you can control whether Kubernetes deletes the object&rsquo;s dependents automatically, in a process called cascading deletion.</p></blockquote></li></ol><h2 id=check-and-update-deployment-if-necessary><a href=https://github.com/nakamasato/sample-controller/commit/10166c22a56a9412b4b3548baea7167b5eaf31c0>5.4. Check and update Deployment if necessary</a></h2><h3 id=541-overview>5.4.1. Overview</h3><p><img src=overview-4.drawio.svg alt></p><p>What needs to be done:</p><ul><li>In <code>syncHandler</code><ul><li><input checked disabled type=checkbox> Check if the found <code>Deployment</code> is managed by the <code>sample-controller</code>.</li><li><input checked disabled type=checkbox> Check if the found <code>Deployment</code>&rsquo;s <code>replicas</code> is same as the specified <code>replica</code> in <code>Foo</code> resource.</li></ul></li><li>In <code>NewController</code><ul><li><input checked disabled type=checkbox> Set <code>UpdateFunc</code> as an event handler for the informer in order to call <code>syncHandler</code> when <code>Foo</code> resource is updated.</li></ul></li></ul><h3 id=542-implement>5.4.2. Implement</h3><ol><li><p>Add constant variable before <code>type Controller struct</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// MessageResourceExists is the message used for Events when a resource
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fails to sync due to a Deployment already existing
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>MessageResourceExists</span> <span class=p>=</span> <span class=s>&#34;Resource %q already exists and is not managed by Foo&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div></li><li><p>Update <code>syncHandler</code>:</p><ol><li><p>Remove log <code>klog.Infof("deployment %s is valid", deployment.Name)</code>.</p></li><li><p>Check if the <code>Deployment</code> is managed by the controller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=c1>// If the Deployment is not controlled by this Foo resource, we should log
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// a warning to the event recorder and return error msg.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>metav1</span><span class=p>.</span><span class=nf>IsControlledBy</span><span class=p>(</span><span class=nx>deployment</span><span class=p>,</span> <span class=nx>foo</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>msg</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>MessageResourceExists</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div></li><li><p>Check the replica and update <code>Deployment</code> object if replicas in <code>Deployment</code> and <code>Foo</code> differ.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=c1>// If this number of the replicas on the Foo resource is specified, and the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// number does not equal the current desired replicas on the Deployment, we
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// should update the Deployment resource.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=nx>foo</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=o>!=</span> <span class=o>*</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Foo %s replicas: %d, deployment replicas: %d&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=o>*</span><span class=nx>foo</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>,</span> <span class=o>*</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>deployment</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>kubeclientset</span><span class=p>.</span><span class=nf>AppsV1</span><span class=p>().</span><span class=nf>Deployments</span><span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nf>newDeployment</span><span class=p>(</span><span class=nx>foo</span><span class=p>),</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If an error occurs during Update, we&#39;ll requeue the item so we can
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// attempt processing again later. This could have been caused by a
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// temporary network failure, or any other transient reason.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div></li></ol></li><li><p>Update event handlers in <code>NewController</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>        _, err := fooInformer.Informer().AddEventHandler(
</span></span><span class=line><span class=cl>                cache.ResourceEventHandlerFuncs{
</span></span><span class=line><span class=cl><span class=gd>-                       AddFunc: controller.handleAdd,
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+                       AddFunc: controller.enqueueFoo,
</span></span></span><span class=line><span class=cl><span class=gi>+                       UpdateFunc: func(old, new interface{}) {
</span></span></span><span class=line><span class=cl><span class=gi>+                               controller.enqueueFoo(new)
</span></span></span><span class=line><span class=cl><span class=gi>+                       },
</span></span></span><span class=line><span class=cl><span class=gi></span>                },
</span></span><span class=line><span class=cl>        )
</span></span></code></pre></div></li><li><p>Remove unused <code>handleAdd</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>-func (c *Controller) handleAdd(obj interface{}) {
</span></span></span><span class=line><span class=cl><span class=gd>-       klog.Info(&#34;handleAdd is called&#34;)
</span></span></span><span class=line><span class=cl><span class=gd>-       c.enqueueFoo(obj)
</span></span></span><span class=line><span class=cl><span class=gd>-}
</span></span></span></code></pre></div></li></ol><h3 id=543-run-and-check-sample-controller-updates-replicas>5.4.3. Run and check: <code>sample-controller</code> updates replicas</h3><ol><li><p>Run the controller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li><p>Apply <code>Foo</code> resource.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get deploy
</span></span><span class=line><span class=cl>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>foo-sample   1/1     1            1           3h41m
</span></span></code></pre></div></li><li><p>Increase Foo&rsquo;s replica to 2.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl patch foo foo-sample -p &#39;{&#34;spec&#34;:{&#34;replicas&#34;: 2}}&#39; --type=merge
</span></span></code></pre></div><p>logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2022/07/19 09:55:00 Foo foo-sample replicas: 2, deployment replicas: 1
</span></span><span class=line><span class=cl>2022/07/19 09:55:00 Successfully synced &#39;default/foo-sample&#39;
</span></span></code></pre></div><p>Replicas of Deployment increased.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get deploy
</span></span><span class=line><span class=cl>NAME         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>foo-sample   2/2     2            2           3h42m
</span></span></code></pre></div></li><li><p>Delete <code>Foo</code> resource.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span></code></pre></div></li></ol><h3 id=544-run-and-check-sample-controller-wouldnt-update-deployment-that-is-not-managed-by-the-controller>5.4.4. Run and check: <code>sample-controller</code> wouldn&rsquo;t update <code>Deployment</code> that is not managed by the controller</h3><ol><li><p>Run the controller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li><p>Apply <code>Deployment</code> with name <code>foo-sample</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl create deployment foo-sample --image=nginx
</span></span></code></pre></div></li><li><p>Apply <code>Foo</code> resource with name <code>foo-sample</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div></li><li><p>Log:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2022/07/19 09:58:27 Resource &#34;foo-sample&#34; already exists and is not managed by Foo
</span></span></code></pre></div></li><li><p>Clean up.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span><span class=line><span class=cl>kubectl delete deploy foo-sample
</span></span></code></pre></div></li></ol><h2 id=update-foo-status><a href=https://github.com/nakamasato/sample-controller/commit/33a55e8035b47e6a10e4deccd3cc313f4a708043>5.5. Update Foo status</a></h2><h3 id=551-overview>5.5.1. Overview</h3><p><img src=overview-5.drawio.svg alt></p><ol><li>Enable <code>status</code> subresource in <code>CustomResourceDefinition</code>.</li><li>Store Deployment&rsquo;s <code>availableReplicas</code> in Foo object&rsquo;s status with <code>UpdateStatus</code> function.</li></ol><h3 id=552-implement>5.5.2. Implement</h3><ol><li><p>Create <code>updateFooStatus</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>updateFooStatus</span><span class=p>(</span><span class=nx>foo</span> <span class=o>*</span><span class=nx>samplev1alpha1</span><span class=p>.</span><span class=nx>Foo</span><span class=p>,</span> <span class=nx>deployment</span> <span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// NEVER modify objects from the store. It&#39;s a read-only, local cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// You can use DeepCopy() to make a deep copy of original object and modify this copy
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Or create a copy manually for better performance
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fooCopy</span> <span class=o>:=</span> <span class=nx>foo</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>fooCopy</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AvailableReplicas</span> <span class=p>=</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>AvailableReplicas</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If the CustomResourceSubresources feature gate is not enabled,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// we must use Update instead of UpdateStatus to update the Status block of the Foo resource.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// UpdateStatus will not allow changes to the Spec of the resource,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// which is ideal for ensuring nothing other than resource status has been updated.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>sampleclientset</span><span class=p>.</span><span class=nf>ExampleV1alpha1</span><span class=p>().</span><span class=nf>Foos</span><span class=p>(</span><span class=nx>foo</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>UpdateStatus</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>fooCopy</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>Add the logic at the end of <code>syncHandler</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>syncHandler</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Finally, we update the status block of the Foo resource to reflect the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// current state of the world
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>updateFooStatus</span><span class=p>(</span><span class=nx>foo</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to update Foo status for %s&#34;</span><span class=p>,</span> <span class=nx>foo</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></li><li><p>Add <code>subresources</code> to <code>CustomResourceDefinition</code> in <code>config/crd/foos.yaml</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>      </span><span class=nt>subresources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span></code></pre></div><p>For more details, see <a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#subresources>subresources</a></p></li></ol><h3 id=553-run-and-check>5.5.3. Run and check</h3><ol><li><p>Apply the changes in CRD.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/crd/foos.yaml
</span></span></code></pre></div></li><li><p>Run the controller.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li><p>Apply <code>Foo</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div></li><li><p>Check status (not updated immediately -> will be fixed in the next section.)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get foo foo-sample -o jsonpath=&#39;{.status}&#39;
</span></span><span class=line><span class=cl>{&#34;availableReplicas&#34;:0}%
</span></span></code></pre></div><p>Currently, the informer just monitors <code>Foo</code> resource, which cannot capture the update of <code>Deployment.status.availableReplicas</code>.</p></li><li><p>Check status after a while</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get foo foo-sample -o jsonpath=&#39;{.status}&#39;
</span></span><span class=line><span class=cl>{&#34;availableReplicas&#34;:1}%
</span></span></code></pre></div></li><li><p>Delete <code>Foo</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span></code></pre></div></li></ol><h2 id=capture-the-update-of-deployment><a href=https://github.com/nakamasato/sample-controller/commit/233f763e18f9fe9b8e14e560d1efe27297f4080e>5.6. Capture the update of Deployment</a></h2><h3 id=561-overview>5.6.1. Overview</h3><p><img src=overview-6.drawio.svg alt></p><p>In the previous section, <code>status.availableReplicas</code> is not updated immediately. This is because sample-contrller just monitors our custom resource <code>Foo</code>. In this section, we&rsquo;ll enable to capture changes of Deployments controlled by <code>Foo</code>.</p><h3 id=562-implement>5.6.2. Implement</h3><ol><li><p>Add <code>handleObject</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// handleObject will take any resource implementing metav1.Object and attempt
</span></span></span><span class=line><span class=cl><span class=c1>// to find the Foo resource that &#39;owns&#39; it. It does this by looking at the
</span></span></span><span class=line><span class=cl><span class=c1>// objects metadata.ownerReferences field for an appropriate OwnerReference.
</span></span></span><span class=line><span class=cl><span class=c1>// It then enqueues that Foo resource to be processed. If the object does not
</span></span></span><span class=line><span class=cl><span class=c1>// have an appropriate OwnerReference, it will simply be skipped.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>handleObject</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>object</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Object</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>ok</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>object</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tombstone</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>DeletedFinalStateUnknown</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>object</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>tombstone</span><span class=p>.</span><span class=nx>Obj</span><span class=p>.(</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Recovered deleted object &#39;%s&#39; from tombstone&#34;</span><span class=p>,</span> <span class=nx>object</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Processing object: %s&#34;</span><span class=p>,</span> <span class=nx>object</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>ownerRef</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>GetControllerOf</span><span class=p>(</span><span class=nx>object</span><span class=p>);</span> <span class=nx>ownerRef</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If this object is not owned by a Foo, we should not do anything more
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// with it.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=nx>ownerRef</span><span class=p>.</span><span class=nx>Kind</span> <span class=o>!=</span> <span class=s>&#34;Foo&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>foo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>foosLister</span><span class=p>.</span><span class=nf>Foos</span><span class=p>(</span><span class=nx>object</span><span class=p>.</span><span class=nf>GetNamespace</span><span class=p>()).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ownerRef</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;ignoring orphaned object &#39;%s&#39; of foo &#39;%s&#39;&#34;</span><span class=p>,</span> <span class=nx>object</span><span class=p>.</span><span class=nf>GetSelfLink</span><span class=p>(),</span> <span class=nx>ownerRef</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>enqueueFoo</span><span class=p>(</span><span class=nx>foo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>When <code>Deployment</code> managed by <code>Foo</code> is added/updated/deleted, get the corresponding <code>Foo</code> and put the key (<code>namespace/name</code>) to the workqueue.</p></li><li><p>Add event handlers to <code>deploymentInformer</code> in <code>NewController</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=c1>// Set up an event handler for when Deployment resources change. This
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// handler will lookup the owner of the given Deployment, and if it is
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// owned by a Foo resource then the handler will enqueue that Foo resource for
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// processing. This way, we don&#39;t need to implement custom logic for
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// handling Deployment resources. More info on this pattern:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// https://github.com/kubernetes/community/blob/8cafef897a22026d42f5e5bb3f104febe7e29830/contributors/devel/controllers.md
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>deploymentInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>AddFunc</span><span class=p>:</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>handleObject</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>UpdateFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>old</span><span class=p>,</span> <span class=nx>new</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>newDepl</span> <span class=o>:=</span> <span class=nx>new</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldDepl</span> <span class=o>:=</span> <span class=nx>old</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>newDepl</span><span class=p>.</span><span class=nx>ResourceVersion</span> <span class=o>==</span> <span class=nx>oldDepl</span><span class=p>.</span><span class=nx>ResourceVersion</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Periodic resync will send update events for all known Deployments.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// Two different versions of the same Deployment will always have different RVs.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>controller</span><span class=p>.</span><span class=nf>handleObject</span><span class=p>(</span><span class=nx>new</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>handleObject</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error occurred when adding event handler %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>FlushAndExit</span><span class=p>(</span><span class=nx>klog</span><span class=p>.</span><span class=nx>ExitFlushTimeout</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div></li></ol><h3 id=563-run-and-check>5.6.3. Run and check</h3><ol><li>Run the controller<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li>Create Foo resource.<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div></li><li>Check Foo&rsquo;s status (will be immediately updated.)<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get foo foo-sample -o jsonpath=&#39;{.status}&#39;
</span></span><span class=line><span class=cl>{&#34;availableReplicas&#34;:1}
</span></span></code></pre></div></li><li>Check again by changing the replicas<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl patch foo foo-sample -p &#39;{&#34;spec&#34;:{&#34;replicas&#34;: 2}}&#39; --type=merge
</span></span></code></pre></div></li><li>Check Foo&rsquo;s status (will be immediately updated.)<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get foo foo-sample -o jsonpath=&#39;{.status}&#39;
</span></span><span class=line><span class=cl>{&#34;availableReplicas&#34;:2}
</span></span></code></pre></div></li><li>Delete <code>Foo</code>.<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span></code></pre></div></li></ol><h2 id=create-events-for-foo-resource><a href=https://github.com/nakamasato/sample-controller/commit/d13aee660898c3d3dd9525df4ca60f7764d782ec>5.7. Create events for Foo resource</a></h2><h3 id=571-overview>5.7.1. Overview</h3><ol><li>Add <code>record.EventRecorder</code> to <code>Controller</code>.</li><li>Emit an event with <code>c.recorder.Event</code> in <code>syncHandler</code>.</li></ol><h3 id=572-implement>5.7.2. Implement</h3><ol><li><p>Add necessary packages.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -13,20 +13,34 @@ import (
</span></span></span><span class=line><span class=cl><span class=gu></span>        &#34;k8s.io/apimachinery/pkg/util/wait&#34;
</span></span><span class=line><span class=cl>        appsinformers &#34;k8s.io/client-go/informers/apps/v1&#34;
</span></span><span class=line><span class=cl>        &#34;k8s.io/client-go/kubernetes&#34;
</span></span><span class=line><span class=cl><span class=gi>+       typedcorev1 &#34;k8s.io/client-go/kubernetes/typed/core/v1&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>        appslisters &#34;k8s.io/client-go/listers/apps/v1&#34;
</span></span><span class=line><span class=cl>        &#34;k8s.io/client-go/tools/cache&#34;
</span></span><span class=line><span class=cl><span class=gi>+       &#34;k8s.io/client-go/tools/record&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>        &#34;k8s.io/client-go/util/workqueue&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        samplev1alpha1 &#34;github.com/nakamasato/sample-controller/pkg/apis/example.com/v
</span></span><span class=line><span class=cl>1alpha1&#34;
</span></span><span class=line><span class=cl>        clientset &#34;github.com/nakamasato/sample-controller/pkg/generated/clientset/versio
</span></span><span class=line><span class=cl>ned&#34;
</span></span><span class=line><span class=cl><span class=gi>+       &#34;github.com/nakamasato/sample-controller/pkg/generated/clientset/versioned/scheme&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>        informers &#34;github.com/nakamasato/sample-controller/pkg/generated/informers/extern
</span></span><span class=line><span class=cl>alversions/example.com/v1alpha1&#34;
</span></span><span class=line><span class=cl>        listers &#34;github.com/nakamasato/sample-controller/pkg/generated/listers/example.com/v1alpha1&#34;
</span></span></code></pre></div></li><li><p>Add <code>eventRecorder</code> to <code>Controller</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl> type Controller struct {
</span></span><span class=line><span class=cl><span class=gu>@@ -43,6 +57,10 @@ type Controller struct {
</span></span></span><span class=line><span class=cl><span class=gu></span>
</span></span><span class=line><span class=cl>        // queue
</span></span><span class=line><span class=cl>        workqueue workqueue.RateLimitingInterface
</span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi>+       // recorder is an event recorder for recording Event resources to the
</span></span></span><span class=line><span class=cl><span class=gi>+       // Kubernetes API.
</span></span></span><span class=line><span class=cl><span class=gi>+       recorder record.EventRecorder
</span></span></span><span class=line><span class=cl><span class=gi></span> }
</span></span></code></pre></div></li><li><p>Initialize <code>eventBroadcaster</code> in <code>NewController</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl> func NewController(
</span></span><span class=line><span class=cl><span class=gu>@@ -50,6 +68,11 @@ func NewController(
</span></span></span><span class=line><span class=cl><span class=gu></span>        sampleclientset clientset.Interface,
</span></span><span class=line><span class=cl>        deploymentInformer appsinformers.DeploymentInformer,
</span></span><span class=line><span class=cl>        fooInformer informers.FooInformer) *Controller {
</span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi>+       eventBroadcaster := record.NewBroadcaster()
</span></span></span><span class=line><span class=cl><span class=gi>+       eventBroadcaster.StartStructuredLogging(0)
</span></span></span><span class=line><span class=cl><span class=gi>+       eventBroadcaster.StartRecordingToSink(&amp;typedcorev1.EventSinkImpl{Interface: kubeclientset.CoreV1().Events(&#34;&#34;)})
</span></span></span><span class=line><span class=cl><span class=gi>+       recorder := eventBroadcaster.NewRecorder(scheme.Scheme, corev1.EventSource{Component: controllerAgentName})
</span></span></span><span class=line><span class=cl><span class=gi></span>        controller := &amp;Controller{
</span></span><span class=line><span class=cl>                kubeclientset:     kubeclientset,
</span></span><span class=line><span class=cl>                sampleclientset:   sampleclientset,
</span></span><span class=line><span class=cl><span class=gu>@@ -58,6 +81,7 @@ func NewController(
</span></span></span><span class=line><span class=cl><span class=gu></span>                foosLister:        fooInformer.Lister(),
</span></span><span class=line><span class=cl>                foosSynced:        fooInformer.Informer().HasSynced,
</span></span><span class=line><span class=cl>                workqueue:         workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), &#34;foo&#34;),
</span></span><span class=line><span class=cl><span class=gi>+               recorder:          recorder,
</span></span></span><span class=line><span class=cl><span class=gi></span>        }
</span></span></code></pre></div></li><li><p>Define constants.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gi>+ const controllerAgentName = &#34;sample-controller&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl> const (
</span></span><span class=line><span class=cl><span class=gi>+       // SuccessSynced is used as part of the Event &#39;reason&#39; when a Foo is synced
</span></span></span><span class=line><span class=cl><span class=gi>+       SuccessSynced = &#34;Synced&#34;
</span></span></span><span class=line><span class=cl><span class=gi>+       // ErrResourceExists is used as part of the Event &#39;reason&#39; when a Foo fails
</span></span></span><span class=line><span class=cl><span class=gi>+       // to sync due to a Deployment of the same name already existing.
</span></span></span><span class=line><span class=cl><span class=gi>+       ErrResourceExists = &#34;ErrResourceExists&#34;
</span></span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi></span>        // MessageResourceExists is the message used for Events when a resource
</span></span><span class=line><span class=cl>        // fails to sync due to a Deployment already existing
</span></span><span class=line><span class=cl>        MessageResourceExists = &#34;Resource %q already exists and is not managed by Foo&#34;
</span></span><span class=line><span class=cl><span class=gi>+       // MessageResourceSynced is the message used for an Event fired when a Foo
</span></span></span><span class=line><span class=cl><span class=gi>+       // is synced successfully
</span></span></span><span class=line><span class=cl><span class=gi>+       MessageResourceSynced = &#34;Foo synced successfully&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> )
</span></span></code></pre></div></li><li><p>Record events in <code>syncHandler</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -199,6 +223,7 @@ func (c *Controller) syncHandler(key string) error {
</span></span></span><span class=line><span class=cl><span class=gu></span>        // a warning to the event recorder and return error msg.
</span></span><span class=line><span class=cl>        if !metav1.IsControlledBy(deployment, foo) {
</span></span><span class=line><span class=cl>                msg := fmt.Sprintf(MessageResourceExists, deployment.Name)
</span></span><span class=line><span class=cl><span class=gi>+               c.recorder.Event(foo, corev1.EventTypeWarning, ErrResourceExists, msg)
</span></span></span><span class=line><span class=cl><span class=gi></span>                klog.Info(msg)
</span></span><span class=line><span class=cl>                return fmt.Errorf(&#34;%s&#34;, msg)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl><span class=gu>@@ -228,6 +253,7 @@ func (c *Controller) syncHandler(key string) error {
</span></span></span><span class=line><span class=cl><span class=gu></span>                return err
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+       c.recorder.Event(foo, corev1.EventTypeNormal, SuccessSynced, MessageResourceSynced)
</span></span></span><span class=line><span class=cl><span class=gi></span>        return nil
</span></span><span class=line><span class=cl> }
</span></span></code></pre></div></li><li><p>Run <code>go mod tidy</code>.</p></li></ol><h3 id=573-run-and-check>5.7.3 Run and check</h3><ol><li>Run the controller.<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>go run .
</span></span></code></pre></div></li><li>Apply <code>Foo</code>.<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl apply -f config/sample/foo.yaml
</span></span></code></pre></div></li><li>Check <code>event</code>.<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl get event --field-selector involvedObject.kind=Foo
</span></span><span class=line><span class=cl>LAST SEEN   TYPE     REASON   OBJECT           MESSAGE
</span></span><span class=line><span class=cl>22s         Normal   Synced   foo/foo-sample   Foo synced successfully
</span></span></code></pre></div></li><li>Delete <code>Foo</code>.<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubectl delete -f config/sample/foo.yaml
</span></span></code></pre></div></li></ol></div></div></div></div></div></div><div class=sub-footer><div class=container><div class=row><div class=col-12><div class=sub-footer-inner><ul><li class=zerostatic><a href=https://www.zerostatic.io>www.zerostatic.io</a></li></ul></div></div></div></div></div><script type=text/javascript src=/sample-controller/js/scripts.min.302a6fc365d5139fb98cf60bdb8f715d96257ea189161d36c190ccfa8182e569.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9NTB93RVPJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9NTB93RVPJ")</script></body></html>