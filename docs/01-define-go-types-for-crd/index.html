<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>1. Define Go types for CRD - Sample Controller</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=https://www.nakamasato.com/sample-controller/favicon.png>
<link rel=stylesheet href=/sample-controller/css/style.min.6719d72e323121369d5caeb4264b95d8a63cf1deaab029da67602fe5a046e0a4.css>
</head>
<body class="page page-default-single">
<div id=main-menu-mobile class=main-menu-mobile>
<ul>
<li class=menu-item-home>
<a href=/sample-controller/>
<span>Home</span>
</a>
</li>
<li class=menu-item-docs>
<a href=/sample-controller/docs/>
<span>Docs</span>
</a>
</li>
</ul>
</div>
<div class=wrapper>
<div class=header>
<div class=container>
<div class=logo>
<a href=https://www.nakamasato.com/sample-controller><img alt=Logo src=/sample-controller/images/logo.svg></a>
</div>
<div class=logo-mobile>
<a href=https://www.nakamasato.com/sample-controller><img alt=Logo src=/sample-controller/images/logo-mobile.svg></a>
</div>
<div id=main-menu class=main-menu>
<ul>
<li class=menu-item-home>
<a href=/sample-controller/>
<span>Home</span>
</a>
</li>
<li class=menu-item-docs>
<a href=/sample-controller/docs/>
<span>Docs</span>
</a>
</li>
</ul>
</div>
<button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
</div>
</div>
<div class="container pt-2 pt-md-6 pb-3 pb-md-6">
<div class=row>
<div class="col-12 col-md-3 mb-3">
<div class=sidebar>
<div class=docs-menu>
<h4>Docs</h4>
<ul>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/00-init-module/>0. Initialize Go module</a>
</li>
<li class=active>
<a href=https://www.nakamasato.com/sample-controller/docs/01-define-go-types-for-crd/>1. Define Go types for CRD</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/02-generate-code/>2. Generate codes</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/03-create-crd-yaml/>3. Create CRD yaml file</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/04-check-points-check-custom-resource-and-codes/>4. Checkpoint</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/05-implement-reconciliation-loop/>5. Implement reconciliation</a>
</li>
</ul>
</div>
</div>
</div>
<div class="col-12 col-md-9">
<h1 class=title>1. Define Go types for CRD</h1>
<div class=content>
<h2 id=1-define-go-types-for-crdhttpsgithubcomnakamasatosample-controllercommitc78f9736454eabbdd8c07f3d37fd1d6a749f9f93><a href=https://github.com/nakamasato/sample-controller/commit/c78f9736454eabbdd8c07f3d37fd1d6a749f9f93>1. Define Go types for CRD</a></h2>
<ol>
<li>
<p>Create a directory.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>mkdir -p pkg/apis/example.com/v1alpha1
</code></pre></div></li>
<li>
<p>Create <code>pkg/apis/example.com/v1alpha1/doc.go</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>v1alpha1</span>
</code></pre></div></li>
<li>
<p>Create <code>pkg/apis/example.com/v1alpha1/types.go</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>v1alpha1</span>

<span class=kn>import</span> <span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>

<span class=c1>// Foo is a specification for a Foo resource
</span><span class=c1></span><span class=kd>type</span> <span class=nx>Foo</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span>   <span class=s>`json:&#34;,inline&#34;`</span>
    <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata,omitempty&#34;`</span>

    <span class=nx>Spec</span>   <span class=nx>FooSpec</span>   <span class=s>`json:&#34;spec&#34;`</span>
    <span class=nx>Status</span> <span class=nx>FooStatus</span> <span class=s>`json:&#34;status&#34;`</span>
<span class=p>}</span>

<span class=c1>// FooSpec is the spec for a Foo resource
</span><span class=c1></span><span class=kd>type</span> <span class=nx>FooSpec</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>DeploymentName</span> <span class=kt>string</span> <span class=s>`json:&#34;deploymentName&#34;`</span>
    <span class=nx>Replicas</span>       <span class=o>*</span><span class=kt>int32</span> <span class=s>`json:&#34;replicas&#34;`</span>
<span class=p>}</span>

<span class=c1>// FooStatus is the status for a Foo resource
</span><span class=c1></span><span class=kd>type</span> <span class=nx>FooStatus</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>AvailableReplicas</span> <span class=kt>int32</span> <span class=s>`json:&#34;availableReplicas&#34;`</span>
<span class=p>}</span>

<span class=c1>// FooList is a list of Foo resources
</span><span class=c1></span><span class=kd>type</span> <span class=nx>FooList</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
    <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListMeta</span> <span class=s>`json:&#34;metadata&#34;`</span>

    <span class=nx>Items</span> <span class=p>[]</span><span class=nx>Foo</span> <span class=s>`json:&#34;items&#34;`</span>
<span class=p>}</span>
</code></pre></div></li>
<li>
<p>Create <code>pkg/apis/example.com/v1alpha1/register.go</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>v1alpha1</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
    <span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
    <span class=s>&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=p>(</span>
    <span class=c1>// SchemeBuilder initializes a scheme builder
</span><span class=c1></span>    <span class=nx>SchemeBuilder</span> <span class=p>=</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>NewSchemeBuilder</span><span class=p>(</span><span class=nx>addKnownTypes</span><span class=p>)</span>
    <span class=c1>// AddToScheme is a global function that registers this API group &amp; version to a scheme
</span><span class=c1></span>    <span class=nx>AddToScheme</span> <span class=p>=</span> <span class=nx>SchemeBuilder</span><span class=p>.</span><span class=nx>AddToScheme</span>
<span class=p>)</span>

<span class=c1>// SchemeGroupVersion is group version used to register these objects.
</span><span class=c1></span><span class=kd>var</span> <span class=nx>SchemeGroupVersion</span> <span class=p>=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersion</span><span class=p>{</span>
    <span class=nx>Group</span><span class=p>:</span>   <span class=s>&#34;example.com&#34;</span><span class=p>,</span>
    <span class=nx>Version</span><span class=p>:</span> <span class=s>&#34;v1alpha1&#34;</span><span class=p>,</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>Resource</span><span class=p>(</span><span class=nx>resource</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupResource</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>WithResource</span><span class=p>(</span><span class=nx>resource</span><span class=p>).</span><span class=nf>GroupResource</span><span class=p>()</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>addKnownTypes</span><span class=p>(</span><span class=nx>scheme</span> <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=nx>scheme</span><span class=p>.</span><span class=nf>AddKnownTypes</span><span class=p>(</span><span class=nx>SchemeGroupVersion</span><span class=p>,</span>
        <span class=o>&amp;</span><span class=nx>Foo</span><span class=p>{},</span>
        <span class=o>&amp;</span><span class=nx>FooList</span><span class=p>{},</span>
    <span class=p>)</span>
    <span class=nx>metav1</span><span class=p>.</span><span class=nf>AddToGroupVersion</span><span class=p>(</span><span class=nx>scheme</span><span class=p>,</span> <span class=nx>SchemeGroupVersion</span><span class=p>)</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><ul>
<li>clientset, which we&rsquo;ll generate in the next section, will uses <code>AddToScheme</code> to register our custom resource <code>Foo</code>.</li>
<li><code>Scheme</code> defines methods for serializing and deserializing API objects, a type registry for converting group, version, and kind information to and from Go schemas, and mappings between Go schemas of different versions.</li>
</ul>
</li>
<li>
<p>Run <code>go mod tidy</code>.</p>
<blockquote>
<p>go mod tidy ensures that the go.mod file matches the source code in the module. It adds any missing module requirements necessary to build the current module’s packages and dependencies, and it removes requirements on modules that don’t provide any relevant packages. It also adds any missing entries to go.sum and removes unnecessary entries.</p>
</blockquote>
<p><a href=https://go.dev/ref/mod#go-mod-tidy>go mod tidy</a></p>
</li>
</ol>
<p>※ At this point, <code>pkg/apis/example.com/v1alpha1/register.go</code> would have an error <code>cannot use &(FooList literal) (value of type *FooList) as "k8s.io/apimachinery/pkg/runtime".Object value in argument to scheme.AddKnownTypes: missing method DeepCopyObject</code> as <code>DeepCopyObject</code> will be generated in the next step.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class=sub-footer>
<div class=container>
<div class=row>
<div class=col-12>
<div class=sub-footer-inner>
<ul>
<li class=zerostatic><a href=https://www.zerostatic.io>www.zerostatic.io</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<script type=text/javascript src=/sample-controller/js/scripts.min.eaf147370baecdd07c022597db631f99cab1c9cd6479de586f30327a568d6a0f.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9NTB93RVPJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-9NTB93RVPJ')</script>
</body>
</html>