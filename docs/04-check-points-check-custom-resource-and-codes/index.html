<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>4. Checkpoint - Sample Controller</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=https://www.nakamasato.com/sample-controller/favicon.png>
<link rel=stylesheet href=/sample-controller/css/style.min.6719d72e323121369d5caeb4264b95d8a63cf1deaab029da67602fe5a046e0a4.css>
</head>
<body class="page page-default-single">
<div id=main-menu-mobile class=main-menu-mobile>
<ul>
<li class=menu-item-home>
<a href=/sample-controller/>
<span>Home</span>
</a>
</li>
<li class=menu-item-docs>
<a href=/sample-controller/docs/>
<span>Docs</span>
</a>
</li>
</ul>
</div>
<div class=wrapper>
<div class=header>
<div class=container>
<div class=logo>
<a href=https://www.nakamasato.com/sample-controller><img alt=Logo src=/sample-controller/images/logo.svg></a>
</div>
<div class=logo-mobile>
<a href=https://www.nakamasato.com/sample-controller><img alt=Logo src=/sample-controller/images/logo-mobile.svg></a>
</div>
<div id=main-menu class=main-menu>
<ul>
<li class=menu-item-home>
<a href=/sample-controller/>
<span>Home</span>
</a>
</li>
<li class=menu-item-docs>
<a href=/sample-controller/docs/>
<span>Docs</span>
</a>
</li>
</ul>
</div>
<button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
</div>
</div>
<div class="container pt-2 pt-md-6 pb-3 pb-md-6">
<div class=row>
<div class="col-12 col-md-3 mb-3">
<div class=sidebar>
<div class=docs-menu>
<h4>Docs</h4>
<ul>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/00-init-module/>0. Initialize Go module</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/01-define-go-types-for-crd/>1. Define Go types for CRD</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/02-generate-code/>2. Generate codes</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/03-create-crd-yaml/>3. Create CRD yaml file</a>
</li>
<li class=active>
<a href=https://www.nakamasato.com/sample-controller/docs/04-check-points-check-custom-resource-and-codes/>4. Checkpoint</a>
</li>
<li>
<a href=https://www.nakamasato.com/sample-controller/docs/05-implement-reconciliation-loop/>5. Implement reconciliation</a>
</li>
</ul>
</div>
</div>
</div>
<div class="col-12 col-md-9">
<h1 class=title>4. Checkpoint</h1>
<div class=content>
<h2 id=4-checkpoint-check-custom-resource-and-codeshttpsgithubcomnakamasatosample-controllercommit1ad23c4575c7726115fd4b37a2833d65982495d5><a href=https://github.com/nakamasato/sample-controller/commit/1ad23c4575c7726115fd4b37a2833d65982495d5>4. Checkpoint: Check custom resource and codes</a></h2>
<h3 id=41-overview>4.1. Overview</h3>
<p><img src=overview.drawio.svg alt></p>
<ol>
<li>Create <code>CustomResourceDefinition</code> <code>foos.example.com</code>.</li>
<li>Create <code>Foo</code> object.</li>
<li>Read the <code>Foo</code> object from <code>main.go</code>.</li>
</ol>
<h3 id=42-implement>4.2. Implement</h3>
<ol>
<li>
<p>Create main.go.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>

<span class=p>}</span>
</code></pre></div></li>
<li>
<p>Init <a href=https://pkg.go.dev/k8s.io/klog/v2>k8s.io/klog/v2</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;k8s.io/klog/v2&#34;</span>
<span class=p>)</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>klog</span><span class=p>.</span><span class=nf>InitFlags</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</code></pre></div></li>
<li>
<p>Set <code>kubeconfig</code> from <a href=https://pkg.go.dev/flag>flag</a>.</p>
<p>If home is detected, use <code>~/.kube/config</code> as default, otherwise, <code>-kubeconfig</code> argument is required.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;flag&#34;</span>
    <span class=s>&#34;path/filepath&#34;</span>
    <span class=o>...</span>
    <span class=s>&#34;k8s.io/client-go/util/homedir&#34;</span>
<span class=p>)</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>var</span> <span class=nx>kubeconfig</span> <span class=o>*</span><span class=kt>string</span>
<span class=k>if</span> <span class=nx>home</span> <span class=o>:=</span> <span class=nx>homedir</span><span class=p>.</span><span class=nf>HomeDir</span><span class=p>();</span> <span class=nx>home</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
    <span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>home</span><span class=p>,</span> <span class=s>&#34;.kube&#34;</span><span class=p>,</span> <span class=s>&#34;config&#34;</span><span class=p>),</span> <span class=s>&#34;(optional)&#34;</span><span class=p>)</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;absolute path to kubeconfig file&#34;</span><span class=p>)</span>
<span class=p>}</span>
<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</code></pre></div></li>
<li>
<p>Set config for Kubernetes client with <a href=https://pkg.go.dev/k8s.io/client-go/tools/clientcmd>client-go/tools/clientcmd</a></p>
<p>config is *<a href=https://pkg.go.dev/k8s.io/client-go@v0.24.3/rest#Config>restclient.Config</a></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
    <span class=o>...</span>
    <span class=s>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
<span class=p>)</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>config</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nf>BuildConfigFromFlags</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>kubeconfig</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building kubeconfig: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
<span class=p>}</span>
</code></pre></div></li>
<li>
<p>Initialize clientset for our custom resource.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
    <span class=nx>clientset</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/clientset/versioned&#34;</span>
<span class=p>)</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>exampleClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientset</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building example clientset: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
<span class=p>}</span>
</code></pre></div></li>
<li>
<p>List the custom resource <code>Foo</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;context&#34;</span>
    <span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
<span class=p>)</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=nx>foos</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>exampleClient</span><span class=p>.</span><span class=nf>ExampleV1alpha1</span><span class=p>().</span><span class=nf>Foos</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;listing foos %s %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
<span class=p>}</span>
<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;length of foos is %d&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>foos</span><span class=p>.</span><span class=nx>Items</span><span class=p>))</span>
</code></pre></div></li>
</ol>
<p>Final <code>main.go</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;context&#34;</span>
    <span class=s>&#34;flag&#34;</span>
    <span class=s>&#34;path/filepath&#34;</span>

    <span class=s>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
    <span class=s>&#34;k8s.io/client-go/util/homedir&#34;</span>
    <span class=s>&#34;k8s.io/klog/v2&#34;</span>

    <span class=nx>clientset</span> <span class=s>&#34;github.com/nakamasato/sample-controller/pkg/generated/clientset/versioned&#34;</span>
    <span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>InitFlags</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>

    <span class=kd>var</span> <span class=nx>kubeconfig</span> <span class=o>*</span><span class=kt>string</span>
    <span class=k>if</span> <span class=nx>home</span> <span class=o>:=</span> <span class=nx>homedir</span><span class=p>.</span><span class=nf>HomeDir</span><span class=p>();</span> <span class=nx>home</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
        <span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>home</span><span class=p>,</span> <span class=s>&#34;.kube&#34;</span><span class=p>,</span> <span class=s>&#34;config&#34;</span><span class=p>),</span> <span class=s>&#34;(optional)&#34;</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>kubeconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;absolute path to kubeconfig file&#34;</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>

    <span class=nx>config</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nf>BuildConfigFromFlags</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>kubeconfig</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building kubeconfig: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
    <span class=p>}</span>

    <span class=nx>exampleClient</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientset</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error building example clientset: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
    <span class=p>}</span>

    <span class=nx>foos</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>exampleClient</span><span class=p>.</span><span class=nf>ExampleV1alpha1</span><span class=p>().</span><span class=nf>Foos</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;listing foos %s %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
    <span class=p>}</span>
    <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;length of foos is %d&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>foos</span><span class=p>.</span><span class=nx>Items</span><span class=p>))</span>
<span class=p>}</span>
</code></pre></div><h3 id=43-run-and-check>4.3. Run and check</h3>
<ol>
<li>
<p>Build <code>sample-controller</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>go mod tidy
go build
</code></pre></div></li>
<li>
<p>Register the CRD.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f config/crd/foos.yaml
</code></pre></div></li>
<li>
<p>Run sample-controller.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>./sample-controller
</code></pre></div><p>Result: no <code>Foo</code> exists</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>length of foos is 0
</code></pre></div></li>
<li>
<p>Create sample foo (custom resource) with <code>config/sample/foo.yaml</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>example.com/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Foo</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>foo-sample</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>deploymentName</span><span class=p>:</span><span class=w> </span><span class=l>foo-sample</span><span class=w>
</span><span class=w>    </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>kubectl apply -f config/sample/foo.yaml
</code></pre></div></li>
<li>
<p>Run the controller again.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>./sample-controller
length of foos is 1
</code></pre></div></li>
<li>
<p>Clean up Foo (custom resource).</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>kubectl delete -f config/sample/foo.yaml
</code></pre></div></li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class=sub-footer>
<div class=container>
<div class=row>
<div class=col-12>
<div class=sub-footer-inner>
<ul>
<li class=zerostatic><a href=https://www.zerostatic.io>www.zerostatic.io</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<script type=text/javascript src=/sample-controller/js/scripts.min.eaf147370baecdd07c022597db631f99cab1c9cd6479de586f30327a568d6a0f.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9NTB93RVPJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-9NTB93RVPJ')</script>
</body>
</html>